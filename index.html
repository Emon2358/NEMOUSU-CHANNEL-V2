<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã­ã‚‚ã†ã™ã¡ã‚ƒã‚“ã­ã‚‹ v2</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-storage-compat.js"></script>
    <style>
        /* --- å…¨ä½“çš„ãªã‚¹ã‚¿ã‚¤ãƒ« --- */
        :root {
            --bg-color: #121212;
            --primary-surface-color: #1e1e1e;
            --secondary-surface-color: #2a2a2a;
            --primary-text-color: #e0e0e0;
            --secondary-text-color: #a0a0a0;
            --accent-color: #007bff;
            --accent-hover-color: #0056b3;
            --error-color: #dc3545;
        }

        body {
            margin: 0;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-text-color);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        /* --- èªè¨¼ç”»é¢ --- */
        .auth-container {
            width: 320px;
            padding: 30px;
            background-color: var(--primary-surface-color);
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .auth-container h1 {
            text-align: center;
            margin-bottom: 25px;
            font-size: 24px;
        }

        .auth-form input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--secondary-surface-color);
            background-color: var(--bg-color);
            color: var(--primary-text-color);
            border-radius: 5px;
            box-sizing: border-box;
        }

        .auth-form button {
            width: 100%;
            padding: 12px;
            border: none;
            background-color: var(--accent-color);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .auth-form button:hover {
            background-color: var(--accent-hover-color);
        }

        .toggle-form {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
        }

        .toggle-form a {
            color: var(--accent-color);
            text-decoration: none;
            cursor: pointer;
        }

        /* --- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªç”»é¢ --- */
        .app-container {
            display: none;
            width: 100vw;
            height: 100vh;
            display: flex;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar {
            width: 280px;
            background-color: var(--primary-surface-color);
            display: flex;
            flex-direction: column;
            padding: 15px;
            box-sizing: border-box;
        }
        
        .sidebar-header {
            padding-bottom: 15px;
            border-bottom: 1px solid var(--secondary-surface-color);
        }
        
        .sidebar-header .user-profile {
            display: flex;
            align-items: center;
        }

        .sidebar-header .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
            cursor: pointer;
        }
        
        .sidebar-header .username {
            font-weight: bold;
            font-size: 16px;
        }
        
        .sidebar-controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .sidebar-controls button {
            flex-grow: 1;
            padding: 8px;
            background-color: var(--secondary-surface-color);
            border: none;
            color: var(--primary-text-color);
            cursor: pointer;
            border-radius: 5px;
        }

        .friend-list {
            flex-grow: 1;
            overflow-y: auto;
            margin-top: 15px;
        }
        .friend-list h3 {
            margin-top: 0;
            color: var(--secondary-text-color);
            font-size: 14px;
        }
        
        .friend-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .friend-item:hover, .friend-item.active {
            background-color: var(--secondary-surface-color);
        }
        
        .friend-item .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
        }

        /* ãƒãƒ£ãƒƒãƒˆç”»é¢ */
        .chat-view {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-color);
            background-size: cover;
            background-position: center;
        }

        #chat-placeholder {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: var(--secondary-text-color);
            font-size: 20px;
        }

        #chat-header {
            padding: 15px 20px;
            background-color: rgba(30, 30, 30, 0.8);
            border-bottom: 1px solid var(--secondary-surface-color);
            font-weight: bold;
        }
        
        #chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse; /* æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒä¸‹ã«æ¥ã‚‹ã‚ˆã†ã« */
        }
        
        .message-wrapper {
             display: flex;
             flex-direction: column;
        }

        .message-bubble {
            display: flex;
            margin-bottom: 15px;
            max-width: 70%;
        }

        .message-bubble .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .message-content {
            background-color: var(--primary-surface-color);
            padding: 10px 15px;
            border-radius: 15px;
        }
        
        .message-content .username {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .message-content .timestamp {
            font-size: 10px;
            color: var(--secondary-text-color);
            text-align: right;
        }

        .message-content img.embedded, .message-content video.embedded {
            max-width: 100%;
            border-radius: 10px;
            margin-top: 5px;
        }
        .message-content iframe.embedded {
            width: 400px;
            height: 225px;
            border: none;
            border-radius: 10px;
            margin-top: 5px;
        }
        
        /* è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .message-wrapper.own {
            align-items: flex-end;
        }
        
        .message-wrapper.own .message-bubble {
            flex-direction: row-reverse;
        }

        .message-wrapper.own .message-bubble .avatar {
            margin-left: 10px;
            margin-right: 0;
        }
        
        .message-wrapper.own .message-content {
            background-color: var(--accent-color);
        }
        
        #chat-input-container {
            display: flex;
            padding: 20px;
            background-color: rgba(30, 30, 30, 0.8);
        }
        
        #chat-input {
            flex-grow: 1;
            padding: 12px;
            border: none;
            border-radius: 20px;
            background-color: var(--secondary-surface-color);
            color: var(--primary-text-color);
            margin-right: 10px;
        }

        #chat-send-button, #file-upload-button {
            padding: 10px 15px;
            border: none;
            background-color: var(--accent-color);
            color: white;
            border-radius: 20px;
            cursor: pointer;
        }

        #file-upload-button {
            margin-right: 10px;
        }
        #file-upload-input {
            display: none;
        }

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: var(--primary-surface-color);
            padding: 30px;
            border-radius: 10px;
            width: 400px;
        }
        .modal-content h2 { margin-top: 0; }
        .modal-content input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            box-sizing: border-box;
            background-color: var(--bg-color);
            border: 1px solid var(--secondary-surface-color);
            color: var(--primary-text-color);
        }
        .modal-controls {
            text-align: right;
            margin-top: 20px;
        }
        .modal-controls button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .modal-controls .save-btn { background-color: var(--accent-color); color: white; }
        .modal-controls .cancel-btn { background-color: var(--secondary-surface-color); color: var(--primary-text-color); margin-left: 10px; }
    </style>
</head>
<body>

    <div id="auth-container">
        <div id="login-form" class="auth-form">
            <h1>ãƒ­ã‚°ã‚¤ãƒ³</h1>
            <input type="email" id="login-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required>
            <input type="password" id="login-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required>
            <button id="login-button">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <p class="toggle-form">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„ã§ã™ã‹ï¼Ÿ <a id="show-signup">ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—</a></p>
        </div>
        <div id="signup-form" class="auth-form" style="display: none;">
            <h1>ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—</h1>
            <input type="text" id="signup-username" placeholder="è¡¨ç¤ºå" required>
            <input type="email" id="signup-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" required>
            <input type="password" id="signup-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required>
            <button id="signup-button">ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—</button>
            <p class="toggle-form">æ—¢ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ã™ã‹ï¼Ÿ <a id="show-login">ãƒ­ã‚°ã‚¤ãƒ³</a></p>
        </div>
    </div>

    <div id="app-container" class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">
                 <div class="user-profile">
                    <img id="user-avatar-sidebar" src="default_avatar.png" alt="Avatar" class="avatar">
                    <div>
                        <span id="user-name-sidebar" class="username">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</span>
                    </div>
                </div>
            </div>
            <div class="sidebar-controls">
                <button id="add-friend-btn">ãƒ•ãƒ¬ãƒ³ãƒ‰è¿½åŠ </button>
                <button id="logout-button">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
            <div id="friend-requests" class="friend-list">
                <h3>ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹</h3>
                <div id="friend-requests-list"></div>
            </div>
            <div id="friends" class="friend-list">
                <h3>ãƒ•ãƒ¬ãƒ³ãƒ‰</h3>
                <div id="friend-list-container"></div>
            </div>
        </div>
        <div id="chat-view" class="chat-view">
            <div id="chat-placeholder">ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚’é¸æŠã—ã¦ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹</div>
            <div id="chat-area" style="display: none; flex-direction: column; height: 100%;">
                <div id="chat-header"></div>
                <div id="chat-messages"></div>
                <div id="chat-input-container">
                    <input type="file" id="file-upload-input" accept="image/*,video/*">
                    <button id="file-upload-button">ğŸ“</button>
                    <input type="text" id="chat-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...">
                    <button id="chat-send-button">é€ä¿¡</button>
                </div>
            </div>
        </div>
    </div>

    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <h2>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</h2>
            <p>ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å¤‰æ›´</p>
            <img id="profile-avatar-preview" src="" alt="Avatar" style="width: 100px; height: 100px; border-radius: 50%; cursor: pointer; object-fit: cover;">
            <input type="file" id="avatar-upload-input" style="display: none;" accept="image/*">
            <br><br>
            <label for="profile-username-input">è¡¨ç¤ºå</label>
            <input type="text" id="profile-username-input" placeholder="æ–°ã—ã„è¡¨ç¤ºå">
            <div class="modal-controls">
                <button id="save-profile-btn" class="save-btn">ä¿å­˜</button>
                <button class="cancel-btn" onclick="closeModal('profile-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <div id="add-friend-modal" class="modal">
        <div class="modal-content">
            <h2>ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚’è¿½åŠ </h2>
            <label for="search-user-input">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢</label>
            <input type="email" id="search-user-input" placeholder="friend@example.com">
            <button id="search-user-btn">æ¤œç´¢</button>
            <div id="search-results"></div>
            <div class="modal-controls">
                <button class="cancel-btn" onclick="closeModal('add-friend-modal')">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration (å…ƒã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ã‚‚ã®ã‚’è¨­å®šã—ã¦ãã ã•ã„)
      const firebaseConfig = {
        apiKey: "AIzaSyC-vRKkPaG50imvk55tv91vj7GWNuXe004",
        authDomain: "nemousu-636eb.firebaseapp.com",
        databaseURL: "https://nemousu-636eb-default-rtdb.firebaseio.com",
        projectId: "nemousu-636eb",
        storageBucket: "nemousu-636eb.appspot.com",
        messagingSenderId: "891021279714",
        appId: "1:891021279714:web:c438fc1879e2311e8539bb",
        measurementId: "G-2076VXPFC4",
      };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();
        
        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        let currentUser = null;
        let currentChatId = null;
        let messageListener = null;

        // --- DOMè¦ç´  ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        
        // --- èªè¨¼çŠ¶æ…‹ã®ç›£è¦– ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                authContainer.style.display = 'none';
                appContainer.style.display = 'flex';
                setupUserProfile(user);
                loadFriends();
                loadFriendRequests();
            } else {
                currentUser = null;
                authContainer.style.display = 'flex';
                appContainer.style.display = 'none';
                if (messageListener && currentChatId) {
                   database.ref(`chats/${currentChatId}/messages`).off('child_added', messageListener);
                }
            }
        });

        // --- èªè¨¼æ©Ÿèƒ½ ---
        document.getElementById('show-signup').addEventListener('click', () => {
            loginForm.style.display = 'none';
            signupForm.style.display = 'block';
        });

        document.getElementById('show-login').addEventListener('click', () => {
            loginForm.style.display = 'block';
            signupForm.style.display = 'none';
        });

        document.getElementById('signup-button').addEventListener('click', () => {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const username = document.getElementById('signup-username').value;

            if (!username) {
                alert('è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    const user = userCredential.user;
                    // Authãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä¿å­˜
                    return user.updateProfile({
                        displayName: username,
                        photoURL: 'https://firebasestorage.googleapis.com/v0/b/nemousu-636eb.appspot.com/o/default_avatar.png?alt=media&token=e110756e-82b5-4166-9323-e578a1f879e9' // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ãƒã‚¿ãƒ¼ã®URL
                    }).then(() => {
                        database.ref('users/' + user.uid).set({
                            username: username,
                            email: user.email,
                            photoURL: 'https://firebasestorage.googleapis.com/v0/b/nemousu-636eb.appspot.com/o/default_avatar.png?alt=media&token=e110756e-82b5-4166-9323-e578a1f879e9'
                        });
                    });
                })
                .catch(error => alert(`ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—å¤±æ•—: ${error.message}`));
        });

        document.getElementById('login-button').addEventListener('click', () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => alert(`ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ${error.message}`));
        });

        document.getElementById('logout-button').addEventListener('click', () => {
            auth.signOut();
        });

        // --- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ©Ÿèƒ½ ---
        function setupUserProfile(user) {
            document.getElementById('user-avatar-sidebar').src = user.photoURL || 'default_avatar.png';
            document.getElementById('user-name-sidebar').textContent = user.displayName;
        }

        document.getElementById('user-avatar-sidebar').addEventListener('click', () => {
            document.getElementById('profile-avatar-preview').src = currentUser.photoURL;
            document.getElementById('profile-username-input').value = currentUser.displayName;
            openModal('profile-modal');
        });
        
        document.getElementById('profile-avatar-preview').addEventListener('click', () => {
            document.getElementById('avatar-upload-input').click();
        });

        document.getElementById('avatar-upload-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('profile-avatar-preview').src = event.target.result;
                }
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('save-profile-btn').addEventListener('click', () => {
            const newUsername = document.getElementById('profile-username-input').value;
            const file = document.getElementById('avatar-upload-input').files[0];
            
            if (!newUsername) {
                alert('è¡¨ç¤ºåã¯å¿…é ˆã§ã™ã€‚');
                return;
            }

            if (file) {
                // æ–°ã—ã„ã‚¢ãƒã‚¿ãƒ¼ãŒé¸æŠã•ã‚ŒãŸå ´åˆ
                const filePath = `avatars/${currentUser.uid}/${file.name}`;
                const fileRef = storage.ref(filePath);
                fileRef.put(file).then(snapshot => {
                    snapshot.ref.getDownloadURL().then(photoURL => {
                        updateUserProfile(newUsername, photoURL);
                    });
                });
            } else {
                // åå‰ã®ã¿å¤‰æ›´ã®å ´åˆ
                updateUserProfile(newUsername, currentUser.photoURL);
            }
        });

        function updateUserProfile(username, photoURL) {
             currentUser.updateProfile({
                displayName: username,
                photoURL: photoURL
            }).then(() => {
                database.ref('users/' + currentUser.uid).update({
                    username: username,
                    photoURL: photoURL
                });
                setupUserProfile(currentUser);
                closeModal('profile-modal');
                alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚');
            }).catch(error => alert('æ›´æ–°å¤±æ•—: ' + error.message));
        }

        // --- ãƒ•ãƒ¬ãƒ³ãƒ‰æ©Ÿèƒ½ ---
        document.getElementById('add-friend-btn').addEventListener('click', () => openModal('add-friend-modal'));

        document.getElementById('search-user-btn').addEventListener('click', () => {
            const searchEmail = document.getElementById('search-user-input').value;
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = 'æ¤œç´¢ä¸­...';

            database.ref('users').orderByChild('email').equalTo(searchEmail).once('value', snapshot => {
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const uid = childSnapshot.key;
                        const userData = childSnapshot.val();

                        if (uid === currentUser.uid) {
                             resultsDiv.innerHTML = '<p>è‡ªåˆ†è‡ªèº«ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚</p>';
                             return;
                        }

                        resultsDiv.innerHTML = `
                            <div>
                                <img src="${userData.photoURL}" width="40" height="40" style="border-radius:50%">
                                <span>${userData.username}</span>
                                <button onclick="sendFriendRequest('${uid}')">ç”³è«‹ã‚’é€ã‚‹</button>
                            </div>
                        `;
                    });
                } else {
                    resultsDiv.innerHTML = '<p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>';
                }
            });
        });
        
        function sendFriendRequest(targetUid) {
            const updates = {};
            updates[`/friendRequests/${targetUid}/${currentUser.uid}`] = true;
            updates[`/sentFriendRequests/${currentUser.uid}/${targetUid}`] = true;
            
            database.ref().update(updates).then(() => {
                alert('ãƒ•ãƒ¬ãƒ³ãƒ‰ç”³è«‹ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚');
                document.getElementById('search-results').innerHTML = '';
            });
        }
        
        function loadFriendRequests() {
            const requestsRef = database.ref(`friendRequests/${currentUser.uid}`);
            requestsRef.on('value', snapshot => {
                const listDiv = document.getElementById('friend-requests-list');
                listDiv.innerHTML = '';
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const senderUid = childSnapshot.key;
                        database.ref(`users/${senderUid}`).once('value', userSnapshot => {
                           const userData = userSnapshot.val();
                           const requestEl = document.createElement('div');
                           requestEl.innerHTML = `
                                <span>${userData.username}ã‹ã‚‰ã®ç”³è«‹</span>
                                <button onclick="acceptFriendRequest('${senderUid}')">æ‰¿èª</button>
                                <button onclick="rejectFriendRequest('${senderUid}')">æ‹’å¦</button>
                           `;
                           listDiv.appendChild(requestEl);
                        });
                    });
                }
            });
        }
        
        function acceptFriendRequest(senderUid) {
            const updates = {};
            updates[`/friends/${currentUser.uid}/${senderUid}`] = true;
            updates[`/friends/${senderUid}/${currentUser.uid}`] = true;
            updates[`/friendRequests/${currentUser.uid}/${senderUid}`] = null;
            updates[`/sentFriendRequests/${senderUid}/${currentUser.uid}`] = null;
            
            database.ref().update(updates);
        }
        
        function rejectFriendRequest(senderUid) {
            const updates = {};
            updates[`/friendRequests/${currentUser.uid}/${senderUid}`] = null;
            updates[`/sentFriendRequests/${senderUid}/${currentUser.uid}`] = null;
            
            database.ref().update(updates);
        }

        function loadFriends() {
            const friendsRef = database.ref(`friends/${currentUser.uid}`);
            friendsRef.on('value', snapshot => {
                const listDiv = document.getElementById('friend-list-container');
                listDiv.innerHTML = '';
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const friendUid = childSnapshot.key;
                        database.ref(`users/${friendUid}`).once('value', userSnapshot => {
                            const userData = userSnapshot.val();
                            const friendEl = document.createElement('div');
                            friendEl.className = 'friend-item';
                            friendEl.dataset.uid = friendUid;
                            friendEl.innerHTML = `
                                <img src="${userData.photoURL}" alt="Avatar" class="avatar">
                                <span>${userData.username}</span>
                            `;
                            friendEl.onclick = () => startChat(friendUid, userData.username, userData.photoURL);
                            listDiv.appendChild(friendEl);
                        });
                    });
                }
            });
        }
        
        // --- ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ ---
        function startChat(friendUid, friendName, friendAvatar) {
            document.getElementById('chat-placeholder').style.display = 'none';
            document.getElementById('chat-area').style.display = 'flex';
            document.getElementById('chat-header').textContent = friendName;

            // ä»¥å‰ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
            if (messageListener && currentChatId) {
                database.ref(`chats/${currentChatId}/messages`).off('child_added', messageListener);
            }

            // æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆIDã‚’ç”Ÿæˆ (UIDã‚’ã‚½ãƒ¼ãƒˆã—ã¦ä¸€æ„æ€§ã‚’æ‹…ä¿)
            currentChatId = currentUser.uid < friendUid ? `${currentUser.uid}_${friendUid}` : `${friendUid}_${currentUser.uid}`;
            
            // UIã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            document.querySelectorAll('.friend-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.friend-item[data-uid="${friendUid}"]`).classList.add('active');

            loadChatMessages();
        }

        function loadChatMessages() {
            const messagesDiv = document.getElementById('chat-messages');
            messagesDiv.innerHTML = '';
            
            const messagesRef = database.ref(`chats/${currentChatId}/messages`).orderByChild('timestamp').limitToLast(100);
            
            messageListener = messagesRef.on('child_added', snapshot => {
                const msgData = snapshot.val();
                displayMessage(msgData);
            });
        }

        function displayMessage(msgData) {
            const messagesDiv = document.getElementById('chat-messages');
            const wrapper = document.createElement('div');
            wrapper.className = 'message-wrapper';
            
            if(msgData.senderId === currentUser.uid) {
                wrapper.classList.add('own');
            }

            let messageBody = '';
            // URLã‚’æ¤œå‡ºã—ã¦åŸ‹ã‚è¾¼ã¿
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const textWithLinks = msgData.text.replace(urlRegex, url => `<a href="${url}" target="_blank">${url}</a>`);

            if (msgData.type === 'text') {
                 messageBody = textWithLinks;
                 // ç‰¹å®šã®ã‚µãƒ¼ãƒ“ã‚¹ã®åŸ‹ã‚è¾¼ã¿
                 const youtubeMatch = msgData.text.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=)?(.+)/);
                 if (youtubeMatch) {
                    messageBody += `<br><iframe class="embedded" src="https://www.youtube.com/embed/${youtubeMatch[1]}" frameborder="0" allowfullscreen></iframe>`;
                 }
            } else if (msgData.type === 'image') {
                messageBody = `<img src="${msgData.fileURL}" class="embedded" alt="uploaded image">`;
            } else if (msgData.type === 'video') {
                messageBody = `<video src="${msgData.fileURL}" class="embedded" controls></video>`;
            }

            wrapper.innerHTML = `
                <div class="message-bubble">
                    <img src="${msgData.senderAvatar}" alt="Avatar" class="avatar">
                    <div class="message-content">
                        <div class="username">${msgData.senderName}</div>
                        <div>${messageBody}</div>
                        <div class="timestamp">${new Date(msgData.timestamp).toLocaleTimeString()}</div>
                    </div>
                </div>
            `;
            // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¸€ç•ªä¸Šã«æŒ¿å…¥ï¼ˆflex-direction: column-reverseã®ãŸã‚ï¼‰
            messagesDiv.insertBefore(wrapper, messagesDiv.firstChild);
        }
        
        document.getElementById('chat-send-button').addEventListener('click', sendMessage);
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') sendMessage();
        });

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const messageText = input.value.trim();
            if (messageText === '' || !currentChatId) return;

            const messageData = {
                senderId: currentUser.uid,
                senderName: currentUser.displayName,
                senderAvatar: currentUser.photoURL,
                text: messageText,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                type: 'text'
            };

            database.ref(`chats/${currentChatId}/messages`).push(messageData);
            input.value = '';
        }

        document.getElementById('file-upload-button').addEventListener('click', () => {
            document.getElementById('file-upload-input').click();
        });

        document.getElementById('file-upload-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file || !currentChatId) return;

            const fileType = file.type.split('/')[0]; // 'image' or 'video'
            const filePath = `chat_files/${currentChatId}/${Date.now()}_${file.name}`;
            const fileRef = storage.ref(filePath);

            fileRef.put(file).then(snapshot => {
                snapshot.ref.getDownloadURL().then(downloadURL => {
                    const messageData = {
                        senderId: currentUser.uid,
                        senderName: currentUser.displayName,
                        senderAvatar: currentUser.photoURL,
                        text: `ãƒ•ã‚¡ã‚¤ãƒ«: ${file.name}`,
                        fileURL: downloadURL,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        type: fileType // 'image' or 'video'
                    };
                    database.ref(`chats/${currentChatId}/messages`).push(messageData);
                });
            });
        });

        // --- ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ ---
        function openModal(modalId) { document.getElementById(modalId).style.display = 'flex'; }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }

    </script>
</body>
</html>
